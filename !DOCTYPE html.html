<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Birthday Quiz</title>

  <!-- Telegram Mini App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      margin-right: 10px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    ul {
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>‚ùì –í–æ–ø—Ä–æ—Å: –ö–æ—Ñ–µ –∏–ª–∏ –ß–∞–π?</h2>

  <button id="btn-coffee" onclick="sendAnswer('–ö–æ—Ñ–µ')">‚òï –ö–æ—Ñ–µ</button>
  <button id="btn-tea" onclick="sendAnswer('–ß–∞–π')">üçµ –ß–∞–π</button>

  <h3>üìä –û—Ç–≤–µ—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:</h3>
  <ul id="answers"></ul>

<script>
  // ===============================
  // üì± TELEGRAM INIT
  // ===============================
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand(); // —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

  // ===============================
  // üîë SUPABASE
  // ===============================
  const SUPABASE_URL = 'https://tbvgqxfirapjfxnsuhff.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_W6Ri_ocuTRQC7gAtDLW0KQ_T2zzIngx';

  const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  // ===============================
  // üë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨
  // ===============================
  let userName = '–ì–æ—Å—Ç—å';

  if (tg.initDataUnsafe?.user) {
    userName = tg.initDataUnsafe.user.first_name;
  }

  // ===============================
  // üîí –ë–õ–û–ö–ò–†–û–í–ö–ê
  // ===============================
  const btnCoffee = document.getElementById('btn-coffee');
  const btnTea = document.getElementById('btn-tea');

  if (localStorage.getItem('hasAnswered') === 'true') {
    disableButtons();
  }

  function disableButtons() {
    btnCoffee.disabled = true;
    btnTea.disabled = true;
  }

  // ===============================
  // üì§ –û–¢–ü–†–ê–í–ö–ê –û–¢–í–ï–¢–ê
  // ===============================
  async function sendAnswer(answer) {
    if (localStorage.getItem('hasAnswered') === 'true') return;

    disableButtons();
    localStorage.setItem('hasAnswered', 'true');

    const { error } = await supabaseClient
      .from('answers')
      .insert({
        user_name: userName,
        answer: answer
      });

    if (error) {
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏, —Å–º–æ—Ç—Ä–∏ Console');
      console.error(error);
    }
  }

  // ===============================
  // üì• –ó–ê–ì–†–£–ó–ö–ê
  // ===============================
  async function loadAnswers() {
    const { data } = await supabaseClient
      .from('answers')
      .select('*')
      .order('created_at', { ascending: false });

    render(data);
  }

  function render(data) {
    const list = document.getElementById('answers');
    list.innerHTML = '';

    data.forEach(row => {
      const li = document.createElement('li');
      li.textContent = `${row.user_name}: ${row.answer}`;
      list.appendChild(li);
    });
  }

  // ===============================
  // üî¥ REAL-TIME
  // ===============================
  supabaseClient
    .channel('answers-realtime')
    .on(
      'postgres_changes',
      { event: 'INSERT', table: 'answers' },
      () => loadAnswers()
    )
    .subscribe();

  loadAnswers();
</script>

</body>
</html>
