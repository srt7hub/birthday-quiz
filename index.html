<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ê —Ç—ã –º–µ–Ω—è —Ö–æ—Ä–æ—à–æ –∑–Ω–∞–µ—à—å?</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #0a0a0f;
      --card: #151520;
      --accent: #22c55e;
      --wrong: #ef4444;
      --primary: #6366f1;
      --primary-hover: #818cf8;
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --gold: #fbbf24;
      --silver: #e5e7eb;
      --bronze: #b45309;
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--card);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    h1 { 
      font-size: 28px; 
      margin: 0 0 8px;
      background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    h2 { 
      margin: 0 0 20px; 
      font-size: 22px;
      line-height: 1.4;
    }

    h3 {
      margin: 0 0 16px;
      font-size: 18px;
      color: var(--text-muted);
      font-weight: 600;
    }

    .login-input, .text-input {
      width: 100%;
      padding: 18px 20px;
      font-size: 18px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      margin-bottom: 16px;
      outline: none;
      transition: all 0.2s;
    }

    .login-input:focus, .text-input:focus {
      border-color: var(--primary);
      background: rgba(255,255,255,0.08);
    }

    .login-input::placeholder, .text-input::placeholder {
      color: var(--text-muted);
    }

    .btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      border-radius: 16px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:active {
      transform: scale(0.98);
      background: var(--primary-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    .btn-accent {
      background: var(--accent);
      color: #022c22;
    }

    .question-counter {
      color: var(--primary);
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .question-image {
      width: 100%;
      border-radius: 16px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .answer-btn {
      width: 100%;
      padding: 18px;
      margin: 8px 0;
      font-size: 17px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
      position: relative;
      overflow: hidden;
    }

    .answer-btn:active:not(:disabled) {
      transform: scale(0.98);
      background: rgba(255,255,255,0.08);
    }

    .answer-btn:disabled { 
      opacity: 0.7;
      cursor: default;
    }

    .answer-btn.correct {
      background: rgba(34, 197, 94, 0.2) !important;
      border-color: var(--accent) !important;
      color: var(--accent);
    }

    .answer-btn.wrong {
      background: rgba(239, 68, 68, 0.2) !important;
      border-color: var(--wrong) !important;
      color: var(--wrong);
    }

    .answer-btn.selected {
      background: rgba(99, 102, 241, 0.2);
      border-color: var(--primary);
    }

    .live-answers {
      max-height: 350px;
      overflow-y: auto;
    }

    .live-answer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .live-answer-item:last-child {
      border-bottom: none;
    }

    .live-name {
      font-weight: 600;
    }

    .live-answer-text {
      color: var(--text-muted);
      font-size: 15px;
      text-align: right;
      flex: 1;
      margin-left: 12px;
    }

    .live-answer-item.correct .live-answer-text {
      color: var(--accent);
      font-weight: 600;
    }

    .status-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      margin-left: 8px;
    }

    .status-badge.correct {
      background: rgba(34, 197, 94, 0.2);
      color: var(--accent);
    }

    .podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 12px;
      margin: 24px 0;
      height: 180px;
    }

    .podium-place {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .podium-bar {
      width: 80px;
      border-radius: 16px 16px 8px 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 12px;
      position: relative;
      transition: all 0.5s ease;
    }

    .place-1 .podium-bar {
      height: 140px;
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
      box-shadow: 0 8px 32px rgba(251, 191, 36, 0.3);
    }

    .place-2 .podium-bar {
      height: 100px;
      background: linear-gradient(180deg, #e5e7eb 0%, #9ca3af 100%);
      box-shadow: 0 8px 32px rgba(229, 231, 235, 0.2);
    }

    .place-3 .podium-bar {
      height: 80px;
      background: linear-gradient(180deg, #b45309 0%, #92400e 100%);
      box-shadow: 0 8px 32px rgba(180, 83, 9, 0.2);
    }

    .podium-name {
      font-weight: 700;
      font-size: 15px;
      max-width: 90px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .podium-score {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .results-list {
      margin-top: 20px;
    }

    .result-item {
      display: flex;
      align-items: center;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 16px;
      margin-bottom: 8px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .result-rank {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      margin-right: 16px;
      background: rgba(255,255,255,0.1);
    }

    .result-rank.gold { background: rgba(251, 191, 36, 0.2); color: var(--gold); }
    .result-rank.silver { background: rgba(229, 231, 235, 0.2); color: var(--silver); }
    .result-rank.bronze { background: rgba(180, 83, 9, 0.2); color: #d97706; }

    .result-info {
      flex: 1;
    }

    .result-name {
      font-weight: 600;
      font-size: 16px;
    }

    .result-detail {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .result-score {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }

    .waiting-hint {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
      font-size: 15px;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-style: italic;
    }

    .highlight-wrong {
      background: rgba(239, 68, 68, 0.1);
      border-radius: 8px;
      padding: 2px 8px;
      font-size: 12px;
      color: var(--wrong);
      margin-left: 8px;
    }

    .connection-status {
      position: fixed;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      z-index: 1000;
    }

    .connection-status.offline {
      background: var(--wrong);
    }

    .hidden {
      display: none !important;
    }

    .reveal-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      animation: fadeIn 0.4s ease;
    }

    .stats-bar {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .stat-pill {
      background: rgba(255,255,255,0.05);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .stat-pill.correct {
      background: rgba(34, 197, 94, 0.15);
      color: var(--accent);
    }

    .hero-image {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      margin-bottom: 20px;
    }

    .text-answer-item {
      background: rgba(255,255,255,0.03);
      padding: 16px;
      border-radius: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .text-answer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .text-answer-author {
      font-weight: 600;
      color: var(--primary);
    }

    .text-answer-content {
      color: var(--text);
      line-height: 1.5;
      font-size: 16px;
    }
  </style>
</head>

<body>
<div class="connection-status" id="connStatus"></div>

<div class="app">

  <!-- Screen 1: Login -->
  <div id="loginScreen" class="screen active">
    <div class="card" style="text-align: center; padding: 40px 24px;">
      <img src="https://raw.githubusercontent.com/srt7hub/birthday-quiz/main/images/hero.png" 
           alt="Birthday" 
           class="hero-image"
           onerror="this.style.display='none'">
      <div style="font-size: 48px; margin-bottom: 16px;">üéÇ</div>
      <h1>–ê —Ç—ã –º–µ–Ω—è<br>—Ö–æ—Ä–æ—à–æ –∑–Ω–∞–µ—à—å?</h1>
      <p style="color: var(--text-muted); margin-bottom: 32px; line-height: 1.6;">
        –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –∫–æ –¥–Ω—é —Ä–æ–∂–¥–µ–Ω–∏—è!<br>
        –ü—Ä–æ–≤–µ—Ä–∏–º, –∫—Ç–æ –º–µ–Ω—è –∑–Ω–∞–µ—Ç –ª—É—á—à–µ –≤—Å–µ—Ö
      </p>
      <input 
        type="text" 
        id="nameInput" 
        class="login-input" 
        placeholder="–¢–≤–æ—ë –∏–º—è" 
        maxlength="20"
        autocomplete="off"
      />
      <button class="btn" onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>
  </div>

  <!-- Screen 2: Game -->
  <div id="gameScreen" class="screen">
    <div class="card">
      <div class="question-counter">–í–æ–ø—Ä–æ—Å <span id="qCurrent">1</span> –∏–∑ <span id="qTotal">14</span></div>
      <h2 id="question"></h2>
      <div id="questionImageContainer"></div>
      <div id="answers"></div>
      
      <!-- Buttons that appear after answer -->
      <div id="postAnswerButtons" style="display: none; margin-top: 16px; flex-direction: column; gap: 12px;">
        <button id="showAnswersBtn" class="btn btn-secondary" onclick="revealAnswers()">
          üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–≤–µ—Ç—ã –≤—Å–µ—Ö
        </button>
        <button id="nextBtn" class="btn" onclick="nextQuestion()" style="display: none;">
          –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚û°
        </button>
      </div>
    </div>

    <!-- Hidden until reveal -->
    <div id="answersCard" class="card hidden">
      <h3 id="resultsTitle">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
      <div id="statsContainer" class="stats-bar"></div>
      <div id="liveAnswers" class="live-answers">
        <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>

  <!-- Screen 3: Results -->
  <div id="resultsScreen" class="screen">
    <div class="card" style="text-align: center;">
      <div style="font-size: 48px; margin-bottom: 8px;">üèÜ</div>
      <h1>–ò—Ç–æ–≥–∏ –∏–≥—Ä—ã</h1>
      <p style="color: var(--text-muted); margin-bottom: 8px;">–í–æ—Ç –∫—Ç–æ –∑–Ω–∞–µ—Ç –º–µ–Ω—è –ª—É—á—à–µ –≤—Å–µ—Ö!</p>
    </div>

    <div class="card">
      <div id="podium" class="podium"></div>
      <div id="resultsList" class="results-list"></div>
    </div>

    <div class="card" style="text-align: center;">
      <button class="btn btn-secondary" onclick="resetGame()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
  </div>

</div>

<script>
  // ===============================
  // CONFIG
  // ===============================
  const CONFIG = {
    supabaseUrl: 'https://tbvgqxfirapjfxnsuhff.supabase.co',
    supabaseKey: 'sb_publishable_W6Ri_ocuTRQC7gAtDLW0KQ_T2zzIngx'
  };

  // ===============================
  // STATE
  // ===============================
  function loadState() {
    const saved = localStorage.getItem('quizState');
    if (saved) {
      return JSON.parse(saved);
    }
    return {
      userName: '',
      currentQuestion: 0,
      hasAnswered: false,
      answersRevealed: false,
      userAnswers: [],
      finished: false
    };
  }

  function saveState() {
    localStorage.setItem('quizState', JSON.stringify(state));
  }

  let state = loadState();
  let channel = null;
  let allAnswers = [];

  // ===============================
  // QUESTIONS DATA
  // ===============================
  const questions = [
    {
      text: '–ö–∞–∫ –∑–æ–≤—É—Ç –º–æ–∏—Ö –º–∞–º—É –∏ –ø–∞–ø—É?',
      answers: ['–°”ô—Ä–∏”ô, –ú–∞—Ä–∞—Ç', '–°–∞–Ω–∏—è, –ú”ô“°—Å“Ø—Ç', '–°—É–ª–ø–∞–Ω, –ú–∞–∫—Å–∏–º', '–°”ô–ª–∏–º”ô, –ú–æ—Ä–∞—Ç'],
      correct: 1
    },
    {
      text: '–ö—Ç–æ –º–æ–π –∫—Ä–∞—à?',
      answers: ['–î–∏–º–∞ –ú–∞—Å–ª–µ–Ω–Ω–∏–∫–æ–≤', '–í–∞–Ω—è –î–º–∏—Ç—Ä–∏–µ–Ω–∫–æ', '–ü–∞–≤–µ–ª –ü—Ä–∏–ª—É—á–Ω—ã–π', '–§–∞–¥–∏—Å –ò–¥—Ä–∏—Å–æ–≤'],
      correct: 0
    },
    {
      text: '–û—Ç–∫—É–¥–∞ —É –º–µ–Ω—è —à—Ä–∞–º –Ω–∞ –ª–±—É?',
      answers: ['–£–ø–∞–ª–∞ —Å –∑–∞–±–æ—Ä–∞', '–ù–µ—É–¥–∞—á–Ω–æ –ø–æ–ø–∞–ª–∏ –∫–∞–º–Ω–µ–º', '–£–ø–∞–ª–∞ —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞', '–£–ø–∞–ª–∞ —Å –∫–∞—á–µ–ª–µ–∫'],
      correct: 2
    },
    {
      text: '–ö–µ–º —è —Ö–æ—Ç–µ–ª–∞ —Å—Ç–∞—Ç—å –≤ –¥–µ—Ç—Å—Ç–≤–µ?',
      answers: ['–í—Ä–∞—á–æ–º', '–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä–æ–º', '–£—á–∏—Ç–µ–ª–µ–º', '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä—à–µ–π'],
      correct: 1
    },
    {
      text: '–ú–æ–∏ —Å–∫—Ä—ã—Ç—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã',
      type: 'text',
      placeholder: '–ù–∞–ø–∏—à–∏, –∫–∞–∫–∏–µ —Ç–∞–ª–∞–Ω—Ç—ã —É –º–µ–Ω—è –µ—Å—Ç—å...'
    },
    {
      text: '–ú–æ–π –ª—é–±–∏–º—ã–π –Ω–∞–ø–∏—Ç–æ–∫',
      answers: ['“†—ã–º—ã“ô', '“†”ô“ª“Ø”ô', '–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π —Å–æ–∫', '–ú–∞–Ω–≥–æ-—Å–º—É–∑–∏'],
      correct: 3
    },
    {
      text: '–ì–¥–µ —è –Ω–∏ —Ä–∞–∑—É –Ω–µ –±—ã–ª–∞?',
      answers: ['–•—Ä–∞–º', '–ò–¥—Ä–∏—Å–æ–≤—Å–∫–∞—è –ø–µ—â–µ—Ä–∞', '–ö–æ–Ω—Ü–µ—Ä—Ç –ü–æ–ª–∏–Ω—ã –ì–∞–≥–∞—Ä–∏–Ω–æ–π', '–¶–∏—Ä–∫'],
      correct: 3
    },
    {
      text: '–ß—Ç–æ –º–æ–∂–µ—Ç –≤—ã–±–µ—Å–∏—Ç—å –º–µ–Ω—è –±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ–≥–æ?',
      answers: ['–°–∫—É—á–Ω—ã–µ –ª—é–¥–∏', '–£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞', '–ù–∏—á–µ–≥–æ', '–û–ø–æ–∑–¥–∞–Ω–∏–µ'],
      correct: 3
    },
    {
      text: '–ú–æ–π —Ä–æ—Å—Ç',
      answers: ['159', '160', '161', '162'],
      correct: 2
    },
    {
      text: '–°–∫–æ–ª—å–∫–æ –¥–µ—Ç–µ–π –≤ –º–æ–µ–π —Å–µ–º—å–µ?',
      answers: ['3', '4', '5', '6'],
      correct: 2
    },
    {
      text: '–ú–æ–∏ –ª—é–±–∏–º—ã–µ —Ü–≤–µ—Ç—ã',
      answers: ['–¢—é–ª—å–ø–∞–Ω—ã', '–ö–∞–∫—Ç—É—Å—ã', '–†–æ–∑—ã', '–ö—É—Å—Ç–æ–≤—ã–µ —Ä–æ–∑—ã'],
      correct: 3
    },
    {
      text: '–ö–∞–∫—É—é —Ñ—Ä–∞–∑—É —è –≥–æ–≤–æ—Ä—é, –∫–æ–≥–¥–∞ –≤—Å—ë –ø–æ—à–ª–æ –Ω–µ –ø–æ –ø–ª–∞–Ω—É?',
      answers: ['¬´–ë—ã–≤–∞–µ—Ç, —Ç–æ—Ä–º–æ—à¬ª', '¬´–í—Å—ë, —á—Ç–æ –Ω–∏ –¥–µ–ª–∞–µ—Ç—Å—è ‚Äî –∫ –ª—É—á—à–µ–º—É¬ª', '¬´–Ø —Ç–∞–∫ –∏ –∑–Ω–∞–ª–∞¬ª'],
      correct: 0
    },
    {
      text: '–ß—Ç–æ —è —Å—á–∏—Ç–∞—é —Å–≤–æ–∏–º —Å–∞–º—ã–º –±–æ–ª—å—à–∏–º red flag\'–æ–º?',
      answers: ['–ï—Å–ª–∏ –µ–≥–æ –∑–æ–≤—É—Ç –ê–π–±—É–ª–∞—Ç', '–†–∞–±–æ—Ç–∞–µ—Ç –≤–∞—Ö—Ç–æ–≤—ã–º –º–µ—Ç–æ–¥–æ–º', '–ë–ª–æ–≥–µ—Ä', '–ù–µ –¥–µ—Ä–∂–∏—Ç –æ–±–µ—â–∞–Ω–∏—è'],
      correct: 3
    },
    {
      text: '–ó–∞ —á—Ç–æ –º–µ–Ω—è –º–æ–∂–Ω–æ –ª—é–±–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ —è –±–µ—à—É?',
      type: 'text',
      placeholder: '–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç...'
    }
  ];

  // ===============================
  // INIT
  // ===============================
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  const supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

  window.addEventListener('load', () => {
    if (state.userName) {
      if (state.finished) {
        showScreen('resultsScreen');
        showResults();
      } else {
        showScreen('gameScreen');
        initGame();
      }
    } else {
      showScreen('loginScreen');
    }
  });

  // ===============================
  // NAVIGATION
  // ===============================
  function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
  }

  function startGame() {
    const input = document.getElementById('nameInput');
    const name = input.value.trim();
    
    if (!name) {
      input.style.borderColor = 'var(--wrong)';
      setTimeout(() => input.style.borderColor = '', 300);
      return;
    }

    state.userName = name;
    state.currentQuestion = 0;
    state.hasAnswered = false;
    state.answersRevealed = false;
    state.userAnswers = [];
    state.finished = false;
    saveState();
    
    showScreen('gameScreen');
    initGame();
  }

  function resetGame() {
    localStorage.removeItem('quizState');
    state = {
      userName: '',
      currentQuestion: 0,
      hasAnswered: false,
      answersRevealed: false,
      userAnswers: [],
      finished: false
    };
    showScreen('loginScreen');
    document.getElementById('nameInput').value = '';
  }

  // ===============================
  // GAME LOGIC
  // ===============================
  function initGame() {
    document.getElementById('qTotal').textContent = questions.length;
    
    if (channel) {
      supabaseClient.removeChannel(channel);
    }
    
    renderQuestion();
    
    if (state.hasAnswered) {
      restoreAnsweredState();
    }
  }

  function renderQuestion() {
    allAnswers = [];
    const q = questions[state.currentQuestion];
    
    document.getElementById('qCurrent').textContent = state.currentQuestion + 1;
    document.getElementById('question').textContent = q.text;
    
    // Handle image
    const imgContainer = document.getElementById('questionImageContainer');
    imgContainer.innerHTML = '';
    if (q.image) {
      const img = document.createElement('img');
      img.src = q.image;
      img.className = 'question-image';
      img.alt = 'Question image';
      imgContainer.appendChild(img);
    }
    
    // Reset UI
    document.getElementById('postAnswerButtons').style.display = 'none';
    document.getElementById('showAnswersBtn').style.display = 'block';
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('answersCard').classList.add('hidden');
    document.getElementById('resultsTitle').textContent = q.type === 'text' ? 'üí¨ –û—Ç–≤–µ—Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤' : 'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã';
    
    // Render answers or text input
    const container = document.getElementById('answers');
    container.innerHTML = '';
    
    if (q.type === 'text') {
      // Text input question
      const input = document.createElement('textarea');
      input.className = 'text-input';
      input.placeholder = q.placeholder || '–í–≤–µ–¥–∏ —Å–≤–æ–π –æ—Ç–≤–µ—Ç...';
      input.rows = 3;
      input.id = 'textAnswerInput';
      container.appendChild(input);
      
      const submitBtn = document.createElement('button');
      submitBtn.className = 'btn';
      submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç';
      submitBtn.onclick = () => submitTextAnswer(input.value);
      container.appendChild(submitBtn);
    } else {
      // Multiple choice
      q.answers.forEach((text, i) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = text;
        btn.onclick = () => submitAnswer(i, btn);
        container.appendChild(btn);
      });
    }

    subscribeToAnswers();
  }

  function restoreAnsweredState() {
    const q = questions[state.currentQuestion];
    const container = document.getElementById('answers');
    
    if (q.type === 'text') {
      // For text questions, just disable input
      const input = document.getElementById('textAnswerInput');
      const btn = container.querySelector('.btn');
      if (input) {
        input.disabled = true;
        input.value = '–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
      }
      if (btn) btn.disabled = true;
    } else {
      // Multiple choice
      const buttons = document.querySelectorAll('.answer-btn');
      const lastAnswer = state.userAnswers[state.userAnswers.length - 1];
      
      buttons.forEach((btn, idx) => {
        btn.disabled = true;
        if (idx === q.correct) {
          btn.classList.add('correct');
        }
        if (state.answersRevealed && idx === lastAnswer?.questionIndex && !lastAnswer?.isCorrect) {
          btn.classList.add('wrong');
        }
        if (idx === lastAnswer?.questionIndex) {
          btn.classList.add('selected');
        }
      });
    }

    document.getElementById('postAnswerButtons').style.display = 'flex';
    
    if (state.answersRevealed) {
      document.getElementById('showAnswersBtn').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'block';
      document.getElementById('answersCard').classList.remove('hidden');
      loadExistingAnswers();
    }
  }

  async function submitAnswer(answerIndex, btnElement) {
    if (state.hasAnswered) return;
    state.hasAnswered = true;

    const q = questions[state.currentQuestion];
    const isCorrect = answerIndex === q.correct;
    
    state.userAnswers.push({
      questionIndex: state.currentQuestion,
      isCorrect: isCorrect,
      answerText: q.answers[answerIndex]
    });
    saveState();

    const buttons = document.querySelectorAll('.answer-btn');
    buttons.forEach((btn, idx) => {
      btn.disabled = true;
      if (idx === answerIndex) {
        btn.classList.add('selected');
      }
    });

    try {
      await supabaseClient.from('answers').insert({
        user_name: state.userName,
        question_index: state.currentQuestion,
        question: q.text,
        answer: q.answers[answerIndex],
        is_correct: isCorrect,
        created_at: new Date().toISOString()
      });
    } catch (err) {
      console.error('Failed to save answer:', err);
    }

    document.getElementById('postAnswerButtons').style.display = 'flex';
  }

  async function submitTextAnswer(text) {
    if (state.hasAnswered) return;
    
    const trimmed = text.trim();
    if (!trimmed) {
      const input = document.getElementById('textAnswerInput');
      input.style.borderColor = 'var(--wrong)';
      setTimeout(() => input.style.borderColor = '', 300);
      return;
    }
    
    state.hasAnswered = true;
    
    state.userAnswers.push({
      questionIndex: state.currentQuestion,
      isCorrect: null, // Text answers don't have correct/incorrect
      answerText: trimmed
    });
    saveState();

    const input = document.getElementById('textAnswerInput');
    const btn = document.querySelector('#answers .btn');
    input.disabled = true;
    btn.disabled = true;
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';

    try {
      await supabaseClient.from('answers').insert({
        user_name: state.userName,
        question_index: state.currentQuestion,
        question: questions[state.currentQuestion].text,
        answer: trimmed,
        is_correct: null,
        created_at: new Date().toISOString()
      });
    } catch (err) {
      console.error('Failed to save answer:', err);
    }

    document.getElementById('postAnswerButtons').style.display = 'flex';
  }

  async function revealAnswers() {
    state.answersRevealed = true;
    saveState();

    const q = questions[state.currentQuestion];
    
    if (q.type !== 'text') {
      // Show correct answer for multiple choice
      const buttons = document.querySelectorAll('.answer-btn');
      const lastAnswer = state.userAnswers[state.userAnswers.length - 1];
      
      buttons.forEach((btn, idx) => {
        if (idx === q.correct) {
          btn.classList.add('correct');
        }
        if (idx === lastAnswer?.questionIndex && !lastAnswer?.isCorrect) {
          btn.classList.add('wrong');
        }
      });
    }

    document.getElementById('showAnswersBtn').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'block';
    
    document.getElementById('answersCard').classList.remove('hidden');
    
    await loadExistingAnswers();
  }

  async function loadExistingAnswers() {
    try {
      const { data, error } = await supabaseClient
        .from('answers')
        .select('*')
        .eq('question_index', state.currentQuestion)
        .order('created_at', { ascending: false });

      if (error) throw error;
      
      allAnswers = data || [];
      updateLiveAnswers();
    } catch (err) {
      console.error('Failed to load answers:', err);
    }
  }

  function updateLiveAnswers() {
    const container = document.getElementById('liveAnswers');
    const statsContainer = document.getElementById('statsContainer');
    const q = questions[state.currentQuestion];
    
    if (allAnswers.length === 0) {
      container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª...</div>';
      statsContainer.innerHTML = '';
      return;
    }

    // For text questions, show different UI
    if (q.type === 'text') {
      statsContainer.innerHTML = `<div class="stat-pill">–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤: ${allAnswers.length}</div>`;
      
      container.innerHTML = '';
      allAnswers.forEach(row => {
        const div = document.createElement('div');
        div.className = 'text-answer-item';
        
        const isCurrentUser = row.user_name === state.userName;
        
        div.innerHTML = `
          <div class="text-answer-header">
            <span class="text-answer-author">${row.user_name} ${isCurrentUser ? '(—Ç—ã)' : ''}</span>
          </div>
          <div class="text-answer-content">${escapeHtml(row.answer)}</div>
        `;
        
        container.appendChild(div);
      });
      return;
    }

    // Multiple choice stats
    const answerCounts = {};
    let correctCount = 0;
    
    allAnswers.forEach(a => {
      answerCounts[a.answer] = (answerCounts[a.answer] || 0) + 1;
      if (a.is_correct) correctCount++;
    });

    statsContainer.innerHTML = `
      <div class="stat-pill">–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤: ${allAnswers.length}</div>
      <div class="stat-pill correct">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correctCount}</div>
    `;

    container.innerHTML = '';
    
    allAnswers.forEach(row => {
      const div = document.createElement('div');
      div.className = 'live-answer-item';
      if (row.is_correct) div.classList.add('correct');
      
      const isCurrentUser = row.user_name === state.userName;
      const isUniqueWrong = !row.is_correct && answerCounts[row.answer] === 1;
      
      div.innerHTML = `
        <span class="live-name">${row.user_name} ${isCurrentUser ? '(—Ç—ã)' : ''}</span>
        <span class="live-answer-text">
          ${row.answer}
          ${isUniqueWrong ? '<span class="highlight-wrong">–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π!</span>' : ''}
        </span>
      `;
      
      container.appendChild(div);
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function subscribeToAnswers() {
    const channelName = `answers-q${state.currentQuestion}-${Date.now()}`;
    
    channel = supabaseClient
      .channel(channelName)
      .on(
        'postgres_changes',
        { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'answers',
          filter: `question_index=eq.${state.currentQuestion}`
        },
        payload => {
          console.log('Realtime update:', payload);
          if (state.answersRevealed) {
            loadExistingAnswers();
          }
        }
      )
      .subscribe((status) => {
        const connStatus = document.getElementById('connStatus');
        if (status === 'SUBSCRIBED') {
          connStatus.classList.remove('offline');
        } else {
          connStatus.classList.add('offline');
        }
      });
  }

  function nextQuestion() {
    state.currentQuestion++;
    state.hasAnswered = false;
    state.answersRevealed = false;
    saveState();
    
    if (state.currentQuestion < questions.length) {
      if (channel) {
        supabaseClient.removeChannel(channel);
        channel = null;
      }
      renderQuestion();
    } else {
      state.finished = true;
      saveState();
      showResults();
    }
  }

  // ===============================
  // RESULTS
  // ===============================
  async function showResults() {
    showScreen('resultsScreen');
    
    try {
      const { data: allAnswers, error } = await supabaseClient
        .from('answers')
        .select('*');

      if (error) throw error;

      const scores = {};
      allAnswers.forEach(ans => {
        if (!scores[ans.user_name]) {
          scores[ans.user_name] = { correct: 0, total: 0, textAnswers: 0 };
        }
        scores[ans.user_name].total++;
        if (ans.is_correct === true) scores[ans.user_name].correct++;
        if (ans.is_correct === null) scores[ans.user_name].textAnswers++;
      });

      const leaderboard = Object.entries(scores)
        .map(([name, stats]) => ({
          name,
          correct: stats.correct,
          total: stats.total - stats.textAnswers, // Only count choice questions for score
          textAnswers: stats.textAnswers,
          accuracy: stats.total > 0 ? stats.correct / (stats.total - stats.textAnswers || 1) : 0
        }))
        .sort((a, b) => b.correct - a.correct || b.accuracy - a.accuracy);

      renderPodium(leaderboard.slice(0, 3));
      renderLeaderboard(leaderboard);
    } catch (err) {
      console.error('Failed to load results:', err);
    }
  }

  function renderPodium(top3) {
    const container = document.getElementById('podium');
    container.innerHTML = '';
    
    if (top3.length === 0) return;
    
    const order = [1, 0, 2];
    const places = ['place-2', 'place-1', 'place-3'];
    const emojis = ['ü•à', 'ü•á', 'ü•â'];
    
    order.forEach((idx, pos) => {
      const player = top3[idx];
      if (!player) return;
      
      const div = document.createElement('div');
      div.className = `podium-place ${places[pos]}`;
      div.innerHTML = `
        <div class="podium-bar">${emojis[pos]}</div>
        <div class="podium-name">${player.name}</div>
        <div class="podium-score">${player.correct}/${player.total}</div>
      `;
      container.appendChild(div);
    });
  }

  function renderLeaderboard(leaderboard) {
    const container = document.getElementById('resultsList');
    container.innerHTML = '';
    
    leaderboard.forEach((player, idx) => {
      const div = document.createElement('div');
      div.className = 'result-item';
      
      let rankClass = '';
      if (idx === 0) rankClass = 'gold';
      else if (idx === 1) rankClass = 'silver';
      else if (idx === 2) rankClass = 'bronze';
      
      const isCurrentUser = player.name === state.userName;
      const textBonus = player.textAnswers > 0 ? ` (+${player.textAnswers} —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö)` : '';
      
      div.innerHTML = `
        <div class="result-rank ${rankClass}">${idx + 1}</div>
        <div class="result-info">
          <div class="result-name">${player.name} ${isCurrentUser ? 'üë§' : ''}</div>
          <div class="result-detail">–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏–∑ ${player.total}${textBonus}</div>
        </div>
        <div class="result-score">${player.correct}</div>
      `;
      
      container.appendChild(div);
    });
  }

  // Enter key support
  document.getElementById('nameInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') startGame();
  });

  // Periodic refresh as fallback
  setInterval(() => {
    if (state.userName && !state.finished && 
        document.getElementById('gameScreen').classList.contains('active') &&
        state.answersRevealed) {
      loadExistingAnswers();
    }
  }, 3000);
</script>

</body>
</html>

