<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Birthday Quiz</title>

  <!-- Telegram Mini App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #22c55e;
      --accent-wrong: #ef4444;
      --text: #f9fafb;
      --muted: #9ca3af;
    }
  
    * {
      box-sizing: border-box;
    }
  
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
  
    h2 {
      font-size: 22px;
      margin-bottom: 16px;
      line-height: 1.3;
    }
  
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
  
    .answer-btn {
      width: 100%;
      padding: 16px;
      margin: 10px 0;
      font-size: 18px;
      border-radius: 14px;
      border: none;
      background: #1f2933;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.05s ease, background 0.2s;
    }
  
    .answer-btn:active {
      transform: scale(0.98);
    }
  
    .answer-btn:disabled {
      opacity: 0.6;
    }
  
    .correct {
      background: var(--accent) !important;
      color: #022c22;
      font-weight: bold;
    }
  
    .wrong {
      background: var(--accent-wrong) !important;
      color: #450a0a;
      font-weight: bold;
    }
  
    #nextBtn {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      border-radius: 14px;
      border: none;
      background: #3b82f6;
      color: white;
      margin-top: 12px;
      display: none;
    }
  
    /* –†–ï–ô–¢–ò–ù–ì */
    .rating-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      margin: 8px 0;
      background: #1f2933;
      border-radius: 12px;
      font-size: 16px;
    }
  
    .place {
      font-weight: bold;
      margin-right: 8px;
    }
  
    .gold { background: linear-gradient(135deg, #facc15, #f59e0b); color: #422006; }
    .silver { background: linear-gradient(135deg, #e5e7eb, #9ca3af); color: #111827; }
    .bronze { background: linear-gradient(135deg, #fdba74, #fb923c); color: #431407; }
  
    .center {
      text-align: center;
    }
  
    @media (min-width: 768px) {
      body {
        max-width: 520px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>

<div class="card">
  <h2 id="question"></h2>
  <div id="answers"></div>
  <button id="nextBtn" onclick="nextQuestion()">‚û° –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
</div>

<div id="result"></div>

<button id="nextBtn" onclick="nextQuestion()">‚û° –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>

<div id="result"></div>

<script>
  // ===============================
  // TELEGRAM
  // ===============================
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  const userName = tg.initDataUnsafe?.user?.first_name || '–ì–æ—Å—Ç—å';

  // ===============================
  // SUPABASE
  // ===============================
  const SUPABASE_URL = 'https://tbvgqxfirapjfxnsuhff.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_W6Ri_ocuTRQC7gAtDLW0KQ_T2zzIngx';

  const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  // ===============================
  // –í–û–ü–†–û–°–´
  // ===============================
  const questions = [
    {
      text: '–ö–µ–º —è —Ö–æ—Ç–µ–ª–∞ —Å—Ç–∞—Ç—å –≤ –¥–µ—Ç—Å—Ç–≤–µ?',
      answers: ['–í—Ä–∞—á–æ–º', '–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä–æ–º', '–£—á–∏—Ç–µ–ª–µ–º', '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä—à–µ–π'],
      correct: 1
    },
    {
      text: '–ú–æ–π —Ä–æ—Å—Ç?',
      answers: ['159', '160', '161', '162'],
      correct: 2
    },
    {
      text: '–ö—Ç–æ –º–æ–π –∫—Ä–∞—à?',
      answers: ['–î–∏–º–∞ –ú–∞—Å–ª–µ–Ω–Ω–∏–∫–æ–≤', '–í–∞–Ω—è –î–º–∏—Ç—Ä–∏–µ–Ω–∫–æ', '–ü–∞–≤–µ–ª –ü—Ä–∏–ª—É—á–Ω—ã–π', '–§–∞–¥–∏—Å –ò–¥—Ä–∏—Å–æ–≤'],
      correct: 0
    },
    {
      text: '–û—Ç–∫—É–¥–∞ —à—Ä–∞–º –Ω–∞ –ª–±—É?',
      answers: [
        '–£–ø–∞–ª–∞ —Å –∑–∞–±–æ—Ä–∞',
        '–ù–µ—É–¥–∞—á–Ω–æ –ø–æ–ø–∞–ª–∏ –∫–∞–º–Ω–µ–º',
        '–£–ø–∞–ª–∞ —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞',
        '–£–ø–∞–ª–∞ —Å –∫–∞—á–µ–ª–µ–∫'
      ],
      correct: 2
    }
  ];

  let currentQuestion = 0;
  let score = 0;
  let answered = false;

  const questionEl = document.getElementById('question');
  const answersEl = document.getElementById('answers');
  const nextBtn = document.getElementById('nextBtn');
  const resultEl = document.getElementById('result');

  // ===============================
  // –†–ï–ù–î–ï–† –í–û–ü–†–û–°–ê
  // ===============================
  function renderQuestion() {
    answered = false;
    answersEl.innerHTML = '';
    nextBtn.style.display = 'none';

    const q = questions[currentQuestion];
    questionEl.textContent = `‚ùì ${q.text}`;

    q.answers.forEach((text, index) => {
      const btn = document.createElement('button');
      btn.className = 'answer-btn';
      btn.textContent = text;
      btn.onclick = () => selectAnswer(index);
      answersEl.appendChild(btn);
    });
  }

  // ===============================
  // –í–´–ë–û–† –û–¢–í–ï–¢–ê
  // ===============================
  async function selectAnswer(index) {
    if (answered) return;
    answered = true;

    const q = questions[currentQuestion];
    const buttons = document.querySelectorAll('.answer-btn');

    buttons.forEach((b, i) => {
      b.disabled = true;
      if (i === q.correct) b.classList.add('correct');
      if (i === index && i !== q.correct) b.classList.add('wrong');
    });

    const isCorrect = index === q.correct;
    if (isCorrect) score++;

    nextBtn.style.display = 'block';

    await supabaseClient.from('answers').insert({
      user_name: userName,
      question: q.text,
      answer: q.answers[index],
      is_correct: isCorrect
    });
  }

  // ===============================
  // –°–õ–ï–î–£–Æ–©–ò–ô –í–û–ü–†–û–°
  // ===============================
  function nextQuestion() {
    currentQuestion++;
    if (currentQuestion < questions.length) {
      renderQuestion();
    } else {
      showResults();
    }
  }

  // ===============================
  // –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ô–¢–ò–ù–ì
  // ===============================
  async function showResults() {
    questionEl.textContent = 'üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã';
    answersEl.innerHTML = '';
    nextBtn.style.display = 'none';

    const { data } = await supabaseClient
      .from('answers')
      .select('user_name, is_correct');

    const scores = {};

    data.forEach(row => {
      if (!scores[row.user_name]) scores[row.user_name] = 0;
      if (row.is_correct) scores[row.user_name]++;
    });

    const sorted = Object.entries(scores)
      .sort((a, b) => b[1] - a[1]);

    let html = `
  <div class="card center">
    <h2>üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
    <p>–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <strong>${score}</strong> / ${questions.length}</p>
  </div>
`;

sorted.forEach(([name, points], index) => {
  let cls = '';
  let medal = index + 1;

  if (index === 0) cls = 'gold';
  if (index === 1) cls = 'silver';
  if (index === 2) cls = 'bronze';

  html += `
    <div class="rating-item ${cls}">
      <span class="place">${medal}.</span>
      <span>${name}</span>
      <span>${points} ‚≠ê</span>
    </div>
  `;
});

resultEl.innerHTML = html;

  // —Å—Ç–∞—Ä—Ç
  renderQuestion();
</script>

</body>
</html>

