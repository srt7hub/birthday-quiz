<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Birthday Quiz</title>

  <!-- Telegram Mini App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #22c55e;
      --wrong: #ef4444;
      --primary: #3b82f6;
      --text: #f9fafb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 16px;
    }

    h2 { margin: 0 0 16px; }

    .answer-btn {
      width: 100%;
      padding: 16px;
      margin: 10px 0;
      font-size: 18px;
      border-radius: 14px;
      border: none;
      background: #1f2937;
      color: var(--text);
      cursor: pointer;
    }

    .answer-btn:disabled { opacity: 0.6; }

    .correct {
      background: var(--accent) !important;
      color: #022c22;
      font-weight: bold;
    }

    .wrong {
      background: var(--wrong) !important;
      color: #450a0a;
      font-weight: bold;
    }

    #nextBtn {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      border-radius: 14px;
      border: none;
      background: var(--primary);
      color: white;
      margin-top: 12px;
      display: none;
    }

    ul { padding-left: 18px; }
    li { margin: 6px 0; }
  </style>
</head>

<body>
<div class="app">

  <div class="card">
    <h2 id="question"></h2>
    <div id="answers"></div>
    <button id="nextBtn" onclick="nextQuestion()">‚û° –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
  </div>

  <div class="card">
    <h3>üëÄ –ö—Ç–æ –∫–∞–∫ –æ—Ç–≤–µ—Ç–∏–ª:</h3>
    <ul id="liveAnswers"></ul>
  </div>

</div>

<script>
  // ===============================
  // TELEGRAM
  // ===============================
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  const userName = tg.initDataUnsafe?.user?.first_name || '–ì–æ—Å—Ç—å';

  // ===============================
  // SUPABASE
  // ===============================
  const supabaseClient = supabase.createClient(
    'https://tbvgqxfirapjfxnsuhff.supabase.co',
    'sb_publishable_W6Ri_ocuTRQC7gAtDLW0KQ_T2zzIngx'
  );

  // ===============================
  // QUESTIONS
  // ===============================
  const questions = [
    {
      text: '–ö–µ–º —è —Ö–æ—Ç–µ–ª–∞ —Å—Ç–∞—Ç—å –≤ –¥–µ—Ç—Å—Ç–≤–µ?',
      answers: ['–í—Ä–∞—á–æ–º', '–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä–æ–º', '–£—á–∏—Ç–µ–ª–µ–º', '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä—à–µ–π'],
      correct: 1
    },
    {
      text: '–ú–æ–π —Ä–æ—Å—Ç?',
      answers: ['159', '160', '161', '162'],
      correct: 2
    },
    {
      text: '–ö—Ç–æ –º–æ–π –∫—Ä–∞—à?',
      answers: ['–î–∏–º–∞ –ú–∞—Å–ª–µ–Ω–Ω–∏–∫–æ–≤', '–í–∞–Ω—è –î–º–∏—Ç—Ä–∏–µ–Ω–∫–æ', '–ü–∞–≤–µ–ª –ü—Ä–∏–ª—É—á–Ω—ã–π', '–§–∞–¥–∏—Å –ò–¥—Ä–∏—Å–æ–≤'],
      correct: 0
    },
    {
      text: '–û—Ç–∫—É–¥–∞ —à—Ä–∞–º –Ω–∞ –ª–±—É?',
      answers: ['–£–ø–∞–ª–∞ —Å –∑–∞–±–æ—Ä–∞', '–ö–∞–º–µ–Ω—å', '–í–µ–ª–æ—Å–∏–ø–µ–¥', '–ö–∞—á–µ–ª–∏'],
      correct: 2
    }
  ];

  let current = 0;
  let locked = false;

  const qEl = document.getElementById('question');
  const aEl = document.getElementById('answers');
  const nextBtn = document.getElementById('nextBtn');
  const liveList = document.getElementById('liveAnswers');

  // ===============================
  // LOAD LIVE ANSWERS (–í–ê–ñ–ù–û)
  // ===============================
  async function loadLiveAnswers() {
    const { data } = await supabaseClient
      .from('answers')
      .select('user_name, answer')
      .eq('question_index', current)
      .order('created_at', { ascending: false });

    liveList.innerHTML = '';
    data.forEach(row => {
      const li = document.createElement('li');
      li.textContent = `${row.user_name} ‚Äî ${row.answer}`;
      liveList.appendChild(li);
    });
  }

  // ===============================
  // RENDER QUESTION
  // ===============================
  function render() {
    locked = false;
    aEl.innerHTML = '';
    nextBtn.style.display = 'none';

    const q = questions[current];
    qEl.textContent = `‚ùì ${q.text}`;

    loadLiveAnswers();

    q.answers.forEach((text, i) => {
      const btn = document.createElement('button');
      btn.className = 'answer-btn';
      btn.textContent = text;
      btn.onclick = () => answer(i);
      aEl.appendChild(btn);
    });
  }

  // ===============================
  // ANSWER
  // ===============================
  async function answer(i) {
    if (locked) return;
    locked = true;

    const q = questions[current];
    const btns = document.querySelectorAll('.answer-btn');

    btns.forEach((b, idx) => {
      b.disabled = true;
      if (idx === q.correct) b.classList.add('correct');
      if (idx === i && i !== q.correct) b.classList.add('wrong');
    });

    await supabaseClient.from('answers').insert({
      user_name: userName,
      question_index: current,
      question: q.text,
      answer: q.answers[i],
      is_correct: i === q.correct
    });

    nextBtn.style.display = 'block';
  }

  // ===============================
  // NEXT QUESTION
  // ===============================
  function nextQuestion() {
    current++;
    if (current < questions.length) {
      render();
    } else {
      qEl.textContent = 'üéâ –ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!';
      aEl.innerHTML = '';
      liveList.innerHTML = '';
      nextBtn.style.display = 'none';
    }
  }

  // ===============================
  // REAL-TIME SUBSCRIPTION
  // ===============================
  supabaseClient
    .channel('live-answers')
    .on(
      'postgres_changes',
      { event: 'INSERT', table: 'answers' },
      payload => {
        const row = payload.new;
        if (row.question_index === current) {
          const li = document.createElement('li');
          li.textContent = `${row.user_name} ‚Äî ${row.answer}`;
          liveList.prepend(li);
        }
      }
    )
    .subscribe();

  render();
</script>

</body>
</html>
